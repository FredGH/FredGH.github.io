---
#Markdown doc generation: http://rmarkdown.rstudio.com/word_document_format.html
#Markdown cheat sheet: 
#http://nestacms.com/docs/creating-content/markdown-cheat-sheet
#http://rmarkdown.rstudio.com/authoring_basics.html
title: "Stock Trend Following Analysis"
author: Frederic Marechal
date: Jan-Feb, 2017
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

######################################################################### 
######################################################################### 
#######               Loading the Dependent Libraries
######################################################################### 
######################################################################### 
```{r lib_loading}
LoadLibraries= function (){
  library(MASS)
  library(quantmod)
  library(rmarkdown)
  library(class)
  library (ISLR)
  library(e1071)
  library(tree)
  library(randomForest)
  library(nnet)
  library(glmnet)
  library(uuid)
  library ( e1071 )
  library(gbm)
  library ( devtools )
print (" The libraries have been loaded .")
}
LoadLibraries()
```


######################################################################### 
######################################################################### 
#######               Clean-Up
-######################################################################### 
######################################################################### 
```{r lib_cleanup}
#check memory allocation
#for (obj in ls()) { message(obj); print(object.size(get(obj)), units='auto') }
#Clear console
cat("\014")  
```


######################################################################### 
######################################################################### 
#######               Setup / User Configuration
######################################################################### 
######################################################################### 
```{r set_up}
index_name = "XLF"
constituents_full_path = paste(getwd(),"/",index_name,".csv",sep="") 
stock_mk_price_dir = paste(getwd(),"/",sep="")
out_dir = paste(getwd(),"/",sep="")

#constituents_full_path = paste("C:\\Users\\Fred\\Desktop\\Studies\\MSc-DataScience\\Statistical Learning\\Assignments\\Assignment2\\",index_name,".csv",sep="") 
#stock_mk_price_dir = "C:\\Users\\Fred\\Desktop\\Studies\\MSc-DataScience\\Statistical Learning\\Assignments\\Assignment2\\"
#out_dir = "C:\\Users\\Fred\\Desktop\\Studies\\MSc-DataScience\\Statistical Learning\\Assignments\\Assignment2\\"

max_nb_stocks = 2

cat("Consituent list full path:",constituents_full_path, sep=" ")
cat("Stock mkt price directory:",stock_mk_price_dir, sep=" ")
cat("Ouput directory:",out_dir, sep=" ")

test_set_bucket = 5 # 5days
#validation_set_bucket = 5*4 # 5days * 4 weeks 
#training_set_bucket = 5*16 # 5days * 16 weeks
#validation_set_bucket = 5*11 # 5days * 11 weeks 
#training_set_bucket = 5*44 # 5days * 44 weeks
#validation_set_bucket = 5*8 # 5days * 8 weeks 
#training_set_bucket = 5*32 # 5days * 32 weeks
#validation_set_bucket = 5*13 # 5days * 13 weeks (65 days)
#training_set_bucket = 5*52 # 5days *52 weeks (260 days)
validation_set_bucket = 5*26 # 5days * 13 weeks (65 days)
training_set_bucket = 5*104 # 5days *52 weeks (260 days)
number_sliding_windows = 100 #number of time sliding windows
cat("Time Series - Number of sliding time windows:",number_sliding_windows, sep=" ")
cat("Test set bucket size (nb of business days):",test_set_bucket, sep=" ")
cat("Valdation set bucket size (nb of business days):",validation_set_bucket, sep=" ")
cat("Training set bucket size (nb of business days):",training_set_bucket, sep=" ")

epsilon = 0.0025
#epsilon = 0.002
cat("Epsilon:",epsilon, sep=" ")
```


######################################################################### 
######################################################################### 
#######               Shared Functions 
######################################################################### 
######################################################################### 
```{r shared_functions}
#Get the full directory path based on the patial directory path
get_directory_full_path = function(directory_path){
  dir_path = getwd();
  if (length(directory_path)>0){
    dir_path = directory_path
  }
  return(dir_path)
}

#Load a csv file given a directory and file name and return a data as a list
load_from_csv = function(directory_name,file_name){
  dir_path = get_directory_full_path(directory_name)
  data = read.csv(paste(dir_path,file_name,".csv", sep=""))
  return (data)
}

#Save data into a csv file, given the directory name and file name
save_to_csv = function(data, directory_name,file_name){
  dir_path = get_directory_full_path(directory_name)
  file_path = paste(dir_path,file_name, sep="")[[1]]
  write.csv(data, file = file_path, row.names = FALSE)
}

#This function the log_returns. It indicates whether the market when up, down or sideways (neutral) from one day to the next. 
#Please ensure the dataset is ordered in data descending order, as the calculations assume the ordering for the calculation  
generate_log_returns_and_direction = function (stock_df, epsilon){
  stock_df["Direction"] = NA
  stock_df["Log_returns"] = NA
  
  for (k in 1:nrow(stock_df)) {
      #Generate the log return value
      stock_df[k,"Log_returns"] =  log10(stock_df$Close[k+1] / stock_df$Close[k])
      #Indicate whether it is going up, down or neutral
      if (k < nrow(stock_df)) {
        if (!is.na( stock_df[k,"Log_returns"])){
          #This is the default values of the 'Direction' and 'Direction_Flag'
          stock_df[k,"Direction"] = 'NA'
          stock_df[k,"Direction_Flag"] = -1
          #Do the Epsilon check
          if (abs(stock_df[k,"Log_returns"]) <= epsilon){
            stock_df[k,"Direction"] = 'Neutral'
            stock_df[k,"Direction_Flag"] = 1
          } 
          else {
            #When the return is greater today compared to the day before,
            #then set the Direction to Up and Direction_Flag to 2
            if (stock_df[k,"Log_returns"] > epsilon){ 
                stock_df[k,"Direction"] = 'Up'
                stock_df[k,"Direction_Flag"] = 2
            }
            #Else set the Direction to Up and Direction_Flag to 2
            else {
                stock_df[k,"Direction"] = 'Down'
                stock_df[k,"Direction_Flag"] = 0
            }
          }
        }
      } 
    }
  return(stock_df)
}

#Add the Close price day lag to the analysis 
add_close_price_day_lag = function (stock_df, nb_days){
  #Ensure the dataset is ordered in data descending order,
  #as the calculations assume the ordering for the calculation  

  #Generate the column dynalically based on the nb_days
  close_price_lag = paste("Close_price_", nb_days, "day_lag", sep="")
  for (k in 1:nrow(stock_df)) {
    stock_df[k,close_price_lag] = stock_df[k+nb_days,"Close"] 
  }
  return (stock_df)
}

#This function process the raw data in order to serve the machine learning models
#For example, it produces technical indicators and other values.
pre_process_data = function (stock_mk_price_dir, stock_name){
  #Get the stock market price data
  sma_df = load_from_csv(stock_mk_price_dir, stock_name )

  sma_df["DateAsDate"] = as.Date(sma_df$Date)
  
  #Sort by increasing dates
  sma_df = sma_df[ order(sma_df$DateAsDate , decreasing = FALSE ),]

  #Add a the indicators column (the average value of the High,Low and Close)
  sma_df["Hlc"] = (sma_df["High"] + sma_df["Low"] + sma_df["Close"])/3
  sma_df["Hl"] = (sma_df["High"] + sma_df["Low"]) /2
  sma_df["Sma20"] = SMA(sma_df$Close, n=20)
  sma_df["Sma50"] = SMA(sma_df$Close, n=50)
  sma_df["Sma100"] = SMA(sma_df$Close, n=100)
  sma_df["Sma200"] = SMA(sma_df$Close, n=200)
  sma_df["Ema20"] = EMA(sma_df$Close, n=20)
  sma_df["Ema50"] = EMA(sma_df$Close, n=50)
  sma_df["Ema100"] = EMA(sma_df$Close, n=100)
  sma_df["Ema200"] = EMA(sma_df$Close, n=200)
  sma_df["Rsi"] = RSI(sma_df$Close, n=14)
  sma_df["Atr_tr"] = ATR(HLC(sma_df[,c("High","Low","Close")]))[][,1]
  sma_df["Atr_atr"] = ATR(HLC(sma_df[,c("High","Low","Close")]))[][,2]
  sma_df["Atr_trueHigh"] = ATR(HLC(sma_df[,c("High","Low","Close")]))[][,3]
  sma_df["Atr_trueLow"] = ATR(HLC(sma_df[,c("High","Low","Close")]))[][,4]
  sma_df["Smi_smi"] = SMI(HLC(sma_df[,c("High","Low","Close")]))[][,1]
  sma_df["Smi_signal"] = SMI(HLC(sma_df[,c("High","Low","Close")]))[][,2]
  sma_df["Macd_macd"] = MACD((sma_df[,c("Close")]))[][,1]
  sma_df["Macd_signal"] = MACD((sma_df[,c("Close")]))[][,2]
  sma_df["Bb_dn"] = BBands(HLC(sma_df[,c("High","Low","Close")]))[][,1]
  sma_df["Bb_mavg"] = BBands(HLC(sma_df[,c("High","Low","Close")]))[][,2]
  sma_df["Bb_up"] = BBands(HLC(sma_df[,c("High","Low","Close")]))[][,3]
  sma_df["Bb_pctB"] = BBands(HLC(sma_df[,c("High","Low","Close")]))[][,4]
  sma_df["Mfi"] = MFI(HLC(sma_df[,c("High","Low","Close")]), sma_df[,c("Volume")])
  sma_df["Sar"] = SAR(sma_df[,c("High","Close")])
  sma_df["Volatility"] = volatility(OHLC(sma_df[,c("Open","High","Low","Close")]), calc = "garman")

  #Add the log returns and up/down
  sma_df = generate_log_returns_and_direction(sma_df, epsilon)

  #Add day lags
  sma_df = add_close_price_day_lag(sma_df, 1)
  sma_df = add_close_price_day_lag(sma_df, 2)
  sma_df = add_close_price_day_lag(sma_df, 3)
  sma_df = add_close_price_day_lag(sma_df, 4)
  sma_df = add_close_price_day_lag(sma_df, 5)

  return (sma_df)
}

get_from_date = function (stock_df, from_date){
  #If the min date of the dataset > from_date , then reset the from_date to min_date
  min_date = min(stock_df$DateAsDate)
  if (min_date>from_date) {
    from_date = min_date
  }
  return (from_date)
}

get_to_date = function (stock_df, to_date){
  #If to_date no            t provided, then default to max date
  if (length(to_date)<0){
    to_date = max(stock_df$DateAsDate)
  }
  else {
    #If the max date of the dataset < to_date , then reset the to_date to max_date
    max_date = max(stock_df$DateAsDate)
    if (to_date > max_date ) {to_date = max_date }
  }
  return (to_date)  
}

#This function plots the different moving averages 
plot_simple_moving_averages = function (stock_df, from_date, to_date){
  #reset display to one graph per window
  par(mfrow=c(1,1))
  
  step_by = "6 mon"
  date_format = "%d-%m-%Y"
  
  from_date = get_from_date(stock_df, from_date);
  to_date = get_to_date(stock_df, to_date);

  #Only plot when dates are consistent
  if(to_date> from_date){
    #Reduce the data range to the required time range 
    stock_df = stock_df[stock_df$DateAsDate >=from_date & stock_df$DateAsDate <=to_date, ]

    #Get the highest y value for the plot
    max_height = max(stock_df$Sma20,stock_df$Sma50,stock_df$Sma100,stock_df$Sma200, na.rm = TRUE)
    min_height = min(stock_df$Sma20,stock_df$Sma50,stock_df$Sma100,stock_df$Sma200, na.rm = TRUE)
    #Plot
    plot( stock_df$DateAsDate, 
          stock_df$Close,
          col="black", 
          type="l", 
          xlab= "",
          xlim=c(from_date,to_date),
          ylab= "Stock Price ($)",
          ylim=c(min_height,max_height),
          main=paste(stock_name,"Close Price Vs Simple Moving Average (SMA) Crossovers\n", from_date, "-", to_date, sep=" "),
          las=2,
          xaxt='n') #this removes the default x-axis label
    axis.Date(1, at=seq(from_date,to_date, by=step_by), format=date_format, las=2)
    lines(stock_df$DateAsDate, stock_df$Sma20,col="green", type="l", ylab= "Sma20")
    lines(stock_df$DateAsDate, stock_df$Sma50,col="blue", type="l", ylab= "Sma50")
    lines(stock_df$DateAsDate, stock_df$Sma100,col="orange", type="l", ylab= "Sma100")
    lines(stock_df$DateAsDate, stock_df$Sma200,col="red", type="l", ylab= "Sma200")
    #inset=c(-0.2,0) to have the legend outside of the plot
    legend( x= "topleft",  legend=c("Close", "Sma20","Sma50", "Sma100", "Sma200"), 
            col=c("black", "green", "blue", "orange", "red"), lty=1, cex=0.8, horiz = TRUE)
    
  }
}

#This function plots the different moving averages 
plot_exponential_moving_averages = function (stock_df, from_date, to_date){
  #reset display to one graph per window
  par(mfrow=c(1,1))
  
  step_by = "6 mon"
  date_format = "%d-%m-%Y"
  
  from_date = get_from_date(stock_df, from_date);
  to_date = get_to_date(stock_df, to_date);

  #Only plot when dates are consistent
  if(to_date> from_date){
    #Reduce the data range to the required time range 
    stock_df = stock_df[stock_df$DateAsDate >=from_date & stock_df$DateAsDate <=to_date, ]

    #Get the highest y value for the plot
    max_height = max(stock_df$Ema20,stock_df$Ema50,stock_df$Ema100,stock_df$Ema200, na.rm = TRUE)
    min_height = min(stock_df$Ema20,stock_df$Ema50,stock_df$Ema100,stock_df$Ema200, na.rm = TRUE)
    #Plot
    plot( stock_df$DateAsDate, 
          stock_df$Close,
          col="black", 
          type="l", 
          xlab= "",
          xlim=c(from_date,to_date),
          ylab= "Stock Price ($)",
          ylim=c(min_height,max_height),
          main=paste(stock_name,"Close Price Vs Exponential Moving Average (EMA) Crossovers\n", from_date, "-", to_date, sep=" "),
          las=2,
          xaxt='n') #this removes the default x-axis label
    axis.Date(1, at=seq(from_date,to_date, by=step_by), format=date_format, las=2)
    lines(stock_df$DateAsDate, stock_df$Ema20,col="green", type="l", ylab= "Ema20")
    lines(stock_df$DateAsDate, stock_df$Ema50,col="blue", type="l", ylab= "Ema50")
    lines(stock_df$DateAsDate, stock_df$Ema100,col="orange", type="l", ylab= "Ema100")
    lines(stock_df$DateAsDate, stock_df$Ema200,col="red", type="l", ylab= "Ema200")
    #inset=c(-0.2,0) to have the legend outside of the plot
    legend( x= "topleft",  legend=c("Close", "Ema20","Ema50", "Ema100", "Ema200"), 
            col=c("black", "green", "blue", "orange", "red"), lty=1, cex=0.8, horiz = TRUE)
    
  }
}

#This function plots the relative strength index (rsi)
plot_relative_strength_index = function (stock_df, from_date, to_date){
  step_by = "3 mon"
  date_format = "%d-%m-%Y"
  
  from_date = get_from_date(stock_df, from_date);
  to_date = get_to_date(stock_df, to_date);
  
  #Display the graphs (one under the other), i.e. in a 2 rows/1 col grid system 
  par(mfrow=2:1)
  
  #Only plot when dates are consistent
  if(to_date> from_date){
    #Reduce the data range to the required time range 
    stock_df = stock_df[stock_df$DateAsDate >=from_date & stock_df$DateAsDate <=to_date, ]

    #Get the highest y value for the plot
    max_height = max(stock_df$Close, na.rm = TRUE)
    min_height = min(stock_df$Close, na.rm = TRUE)
    #Plot
    plot( stock_df$DateAsDate, 
          stock_df$Close,
          col="black", 
          type="l", 
          xlab= "",
          xlim=c(from_date,to_date),
          ylab= "Stock Price ($)",
          ylim=c(min_height,max_height),
          main=paste(stock_name,"Close Price\n", from_date, "-", to_date, sep=" "),
          las=2,
          xaxt='n') #this removes the default x-axis label
    axis.Date(1, at=seq(from_date,to_date, by=step_by), format=date_format, las=2)

    max_height = max(stock_df$Rsi, na.rm = TRUE)
    min_height = min(stock_df$Rsi, na.rm = TRUE)
    plot( stock_df$DateAsDate, 
          stock_df$Rsi,
          col="green", 
          type="l", 
          xlab= "",
          xlim=c(from_date,to_date),
          ylab= "RSI",
          ylim=c(min_height,max_height),
          main=paste(stock_name,"RSI (14days)\n", from_date, "-", to_date, sep=" "),
          las=2,
          xaxt='n') #this removes the default x-axis label
    axis.Date(1, at=seq(from_date,to_date, by=step_by), format=date_format, las=2)
    
    #Two vertical lines, at ordinate = 30 and 70, to show the RSI signal trigger 
    abline(h=70)
    abline(h=30)
    
    #reset display to one graph per window
    par(mfrow=c(1,1))
  }
}


#This function plots the relative strength index (rsi)
plot_prices_volume = function (stock_df, from_date, to_date){
  step_by = "3 mon"
  date_format = "%d-%m-%Y"
  
  from_date = get_from_date(stock_df, from_date);
  to_date = get_to_date(stock_df, to_date);
  
  #Display the graphs (one under the other), i.e. in a 2 rows/1 col grid system 
  par(mfrow=2:1)
  
  #Only plot when dates are consistent
  if(to_date> from_date){
    #Reduce the data range to the required time range 
    stock_df = stock_df[stock_df$DateAsDate >=from_date & stock_df$DateAsDate <=to_date, ]

    #Get the highest y value for the plot
    max_height = max(stock_df$Close, na.rm = TRUE)
    min_height = min(stock_df$Close, na.rm = TRUE)
    #Plot
    plot( stock_df$DateAsDate, 
          stock_df$Close,
          col="black", 
          type="l", 
          lwd=1.5,
          xlab= "",
          xlim=c(from_date,to_date),
          ylab= "Stock Price ($)",
          ylim=c(min_height,max_height),
          main=paste(stock_name,"Close Price\n", from_date, "-", to_date, sep=" "),
          las=2,
          xaxt='n') #this removes the default x-axis label
    axis.Date(1, at=seq(from_date,to_date, by=step_by), format=date_format, las=2)
    lines(stock_df$DateAsDate, stock_df$Close_price_1day_lag,col="orange", type="l", ylab= "1Day Price Lag")
    lines(stock_df$DateAsDate, stock_df$Close_price_4day_lag,col="blue", type="l", ylab= "4Day Price Lag")
    #inset=c(-0.2,0) to have the legend outside of the plot
    legend( x= "topleft",  legend=c("Close", "Close 1-Day Lag", "Close 4-Day Lag"), 
    col=c("black", "orange", "blue"), lty=1, cex=0.8, horiz = TRUE)

    max_height = max(stock_df$Volume, na.rm = TRUE)
    min_height = min(stock_df$Volume, na.rm = TRUE)
    plot( stock_df$DateAsDate, 
          stock_df$Volume,
          col="green", 
          type="l", 
          xlab= "",
          xlim=c(from_date,to_date),
          ylab= "Volume",
          ylim=c(min_height,max_height),
          main=paste(stock_name,"Volume\n", from_date, "-", to_date, sep=" "),
          las=2,
          xaxt='n') #this removes the default x-axis label
    axis.Date(1, at=seq(from_date,to_date, by=step_by), format=date_format, las=2)
    
    #reset display to one graph per window
    par(mfrow=c(1,1))
  }
}


#This function plots the relative strength index (rsi)
plot_log_returns = function (stock_df, from_date, to_date){
  #reset display to one graph per window
  par(mfrow=c(1,1))
  
  step_by = "3 mon"
  date_format = "%d-%m-%Y"
  
  from_date = get_from_date(stock_df, from_date);
  to_date = get_to_date(stock_df, to_date);
  
  #Only plot when dates are consistent
  if(to_date> from_date){
    #Reduce the data range to the required time range 
    stock_df = stock_df[stock_df$DateAsDate >=from_date & stock_df$DateAsDate <=to_date, ]

    #Get the highest y value for the plot
    max_height = max(stock_df$Log_returns, na.rm = TRUE)
    min_height = min(stock_df$Log_returns, na.rm = TRUE)
    #Plot
    plot( stock_df$DateAsDate, 
          stock_df$Log_returns, 
          col="black", 
          type="l", 
          xlab= "",
          xlim=c(from_date,to_date),
          ylab= "Log Returns ($)",
          ylim=c(min_height,max_height),
          main=paste(stock_name,"Log Returns (from Close prices)\n", from_date, "-", to_date, sep=" "),
          las=2,
          xaxt='n') #this removes the default x-axis label
      axis.Date(1, at=seq(from_date,to_date, by=step_by), format=date_format, las=2)

  }
}

#Genrate the Error Rate
error_rate_perc = function(confusion_matrix, msg="NA"){
  res = 100 - accuracy_rate_perc(confusion_matrix,msg)
  return(res)
}

#Genrate the Accuracy Rate
accuracy_rate_perc = function(confusion_matrix, msg="NA"){
  res = 100 * sum(diag(confusion_matrix))/sum(confusion_matrix)
  return(res)
}

print_section_info = function (msg){
    cat("\n")
    cat ("******************************************\n")
    cat (msg)
    cat ("******************************************\n")
    cat("\n")
}

#Add a new row to the stock analysis summary data_frame
add_row_to_summary = function(summary_df,
                              stock_name,
                              is_loaded,
                              start_date, end_date, 
                              nb_row, 
                              removed_missing_values_perc, 
                              importance_name1,importance_value1,
                              importance_name2,importance_value2,
                              importance_name3,importance_value3,
                              importance_name4,importance_value4,
                              importance_name5,importance_value5,
                              importance_name6,importance_value6,
                              importance_name7,importance_value7,
                              importance_name8,importance_value8,
                              importance_name9,importance_value9,
                              importance_name10,importance_value10
                              ){

  #Create a new row for that will be attached to the feature_reduction_summary_df later...
  newrow = c(stock_name,
             is_loaded,
             start_date,end_date,
             nb_row,
             removed_missing_values_perc,
             importance_name1,importance_value1,
             importance_name2,importance_value2,
             importance_name3,importance_value3,
             importance_name4,importance_value4,
             importance_name5,importance_value5,
             importance_name6,importance_value6,
             importance_name7,importance_value7,
             importance_name8,importance_value8,
             importance_name9,importance_value9,
             importance_name10,importance_value10)
  
  #Add the new row to feature reduction summary df
  summary_df[nrow(summary_df)+1, ] <- newrow

  return (summary_df)
}

#Add a new row in the time window dataframe
add_row_to_time_windows = function( time_window_df,
                                    test_end_index, test_start_index,
                                    validation_end_index,validation_start_index,
                                    training_end_index, training_start_index
                              ){

  #Create a new row
  newrow = c( test_end_index, test_start_index,
              validation_end_index, validation_start_index,
              training_end_index, training_start_index )
  
  #Add the new row to the dataset
  time_window_df[nrow(time_window_df)+1, ] <- newrow

  return (time_window_df)
}

#Add a new row to the stock model comparison data_frame
add_row_to_model_summary = function(model_summary_df,
                                    uuid,
                                    stock_name,
                                    model_run_success,
                                    aggregation_type,
                                    model_name,model_desc,model_type,
                                    accuracy_rate,error_rate){

  #Create a new row for that will be attached to the feature_reduction_summary_df later...
  newrow = c( uuid,
              stock_name,
              model_run_success,
              aggregation_type,
              model_name,model_desc,model_type,
              accuracy_rate,error_rate)
  
  #Add the new row to model comparison summary df
  model_summary_df[nrow(model_summary_df)+1, ] <- newrow

  return (model_summary_df)
}

```

######################################################################### 
######################################################################### 
#######               Variable Generation and Feature Selection
######################################################################### 
######################################################################### 
```{r feature_selection} 

cat("Get the index constituents\n")
index_constituents_df = read.csv(constituents_full_path,header=TRUE)
head(index_constituents_df)

#Feature Reduction Summary
feature_reduction_summary_df = data.frame(
                              stock_name = "",
                              is_loaded = "",
                              start_date = "", end_date= "", 
                              nb_row = "", 
                              removed_missing_values_perc = "", 
                              importance_name1= "",importance_value1= "",
                              importance_name2= "",importance_value2= "",
                              importance_name3= "",importance_value3= "",
                              importance_name4= "",importance_value4= "",
                              importance_name5= "",importance_value5= "",
                              importance_name6= "",importance_value6= "",
                              importance_name7= "",importance_value7= "",
                              importance_name8= "",importance_value8= "",
                              importance_name9= "",importance_value9= "",
                              importance_name10= "",importance_value10= "",
                              stringsAsFactors=FALSE)

#Time Windows 
time_window_df = data.frame(
                              test_end_index = 0,
                              test_start_index = 0,
                              validation_end_index = 0,
                              validation_start_index = 0,
                              training_end_index = 0,
                              training_start_index = 0,
                              stringsAsFactors=FALSE)

#List the training and test datasets for each stock under analysis
analysis_dataset_list = list(c("stock_name", "training_data", "test_data"))

cat("For each index constituent (i.e. stock) generate the SMA and plot it...\n")
for (k in 1:dim(index_constituents_df)[1]) {
  if (k<max_nb_stocks){
    stock_name = as.character(index_constituents_df[1][[1]][[k]])
    print_section_info(paste("Start analysis for Stock:", stock_name, ""))
    file_path = paste(stock_mk_price_dir,stock_name, sep="")[[1]]
    file_path_check = paste(file_path,".csv", sep="")[[1]]
    if (!file.exists(file_path_check)){
      #A stock mkt price file is missing... prompt the user...
      cat("WARNING ---> FILE: ", file_path_check, " COULD NOT BE LOADED!\n",sep="")
      feature_reduction_summary_df = add_row_to_summary( feature_reduction_summary_df,
                                                            stock_name,
                                                            "FALSE",
                                                            "","",
                                                            0,
                                                            0,
                                                            "", "",
                                                            "", "",
                                                            "", "",
                                                            "", "", 
                                                            "", "",
                                                            "", "",
                                                            "", "",
                                                            "", "",
                                                            "", "",
                                                            "", "")
    }
    else{
        ######################################################################### 
        ######################################################################### 
        #######             Pre-Process Data
        ######################################################################### 
        #########################################################################
  
        #Generate the dummy explanatory variable (Up/Down/Neutral)
        #Generate a number of technical analysis indicators and other derived data from the price/volume raw data.
        #All this data will be used for model training and testing. 
              
        sma_df = pre_process_data(stock_mk_price_dir, stock_name)
        
        ######################################################################### 
        ######################################################################### 
        #######             Missing Data
        ######################################################################### 
        #########################################################################
        
        #Remove all rows containing NA values
        #count the number of na in the entire dataset
        count_na = sum(is.na(sma_df))
        #remove all the rows containing na values
        sma_df = na.omit(sma_df)
        #count the perc of removed row and perform some sanity check
        removed_missing_values_perc = 100 * count_na / nrow(sma_df)
        cat("Removed missing values represent ", removed_missing_values_perc, " % of the dataset\n", sep ="" )
        count_na = sum(is.na(sma_df))
        if (count_na > 0) {
          cat("**** WARNING... **** \n")
          cat("The NA count in the dataframe should be zero. The actual result is: ", count_na, "\n", sep ="" )  
        }
        
        ######################################################################### 
        ######################################################################### 
        #######             Produce Technical Analysis Visuals
        ######################################################################### 
        #########################################################################

        #Plot Log Returns
        from_date = as.Date("2014-12-30")
        to_date = as.Date("2016-12-30") 
        plot_log_returns(sma_df, from_date, to_date)

        #Plot SMA
        from_date = as.Date("2014-12-30")
        to_date = as.Date("2016-12-30") 
        plot_simple_moving_averages(sma_df, from_date, to_date)
        
        #Plot EMA
        from_date = as.Date("2014-12-30")
        to_date = as.Date("2016-12-30") 
        plot_exponential_moving_averages(sma_df, from_date, to_date)
      
        #Plot RSI
        from_date = as.Date("2014-12-30")
        to_date = as.Date("2016-12-30") 
        plot_relative_strength_index(sma_df, from_date, to_date)
        
        #Plot Prices & Volume
        from_date = as.Date("2014-12-30")
        to_date = as.Date("2016-12-30") 
        plot_prices_volume(sma_df, from_date, to_date)
        
        ######################################################################### 
        ######################################################################### 
        #######             Define the dataframe used for analysis
        ######################################################################### 
        #########################################################################
        
        #Select the list of attributes and explained variable used for the mdel building         
        final_df =  subset(sma_df, 
              select=c( Direction,
                        Direction_Flag,
                        Close_price_1day_lag,Close_price_2day_lag,Close_price_3day_lag,Close_price_4day_lag,Close_price_5day_lag,
                        Sma20,Sma50,Sma100,Sma200,
                        Ema20,Ema50,Ema100,Ema200,
                        Atr_tr,Atr_atr, Atr_trueHigh, Atr_trueLow,
                        Smi_smi,Smi_signal,
                        Macd_macd,Macd_signal,
                        Bb_dn,Bb_mavg, Bb_up, Bb_pctB,
                        Volatility,
                        Mfi, 
                        Sar,
                        Rsi,
                        Volume))
        
        ######################################################################### 
        ######################################################################### 
        #######             Define the Training/Test sets 
        ######################################################################### 
        #########################################################################

        
        #Step 1 - build a list of traning/validation/test sets start/end index
        #We start from the nearest date and we walk backards...
        slid_win_idx = 0
        test_end_index = dim(final_df)[1]
        while (slid_win_idx < number_sliding_windows) {
          test_start_index = test_end_index - test_set_bucket + 1
          validation_end_index = test_start_index - 1
          validation_start_index = validation_end_index - validation_set_bucket + 1
          training_end_index = validation_start_index - 1
          training_start_index = training_end_index - training_set_bucket + 1
          #add the time window to the list
          time_window_df = add_row_to_time_windows(time_window_df,
                                  test_end_index, test_start_index,
                                  validation_end_index, validation_start_index,
                                  training_end_index, training_start_index) 
          #now reset the 'test_end_index' 
          test_end_index = test_end_index - test_set_bucket +1
          if (slid_win_idx > test_end_index ) {
            print("ERROR - The sliding window must be greater than the end test index...")
          }
          slid_win_idx = slid_win_idx + 1 
        }
        #Step 2 - Remove first row as this is necessary (all columns are set to 0)
        time_window_df = time_window_df[-1,]
        #Step 3 - Now reverse the time series in the list to ensure we keep the the time windows in the time order.  
        time_window_df = time_window_df[rev(rownames(time_window_df)),]
        head(time_window_df)


        ######################################################################### 
        ######################################################################### 
        #######             Feature selection 
        ######################################################################### 
        #########################################################################
        
        #The aim of this section is to establish which explanatory variable(s) have the most explanatory power. 
        #The aim is to retain the most variance in the model and reduce the model complexity to enhanced its interpretability.
        #For this, the training data is fitted against a random forest, generate the performance of the model based on the test data. 
        #Then, analyse the total decrease in node impurity that results from splits over that variable, averaged over all other trees.
        
        #The feature seclection is performed on the first training data set
        training_range = time_window_df[1,"training_start_index"]:time_window_df[1,"training_end_index"]
        training_data = final_df[training_range,]
        
        set.seed(1)
        #Feature select against all variables bar (Direction_Flag) as it is 100% correlated to the Direction explanatory variable
        training_fit = randomForest( factor(Direction)~.-Direction_Flag,  #encode the vector as a factor
                                     data=training_data,
                                     #ntree=500, defaulted to 500. This is sufficient for feature selection => 
                                     #(not trying to optimise performance)
                                     #mtry=6, defaulted to SQRT(p) for a classification tree
                                     importance=TRUE)

        
        #Generate the importance data and order by the column "MeanDecreaseGini" (desc)
        importance_res = importance(training_fit)
        importance_res = importance_res[order(importance_res[,"MeanDecreaseGini"] , decreasing = TRUE ),]
        
        #Print the importance table
        print(importance_res)
        #Display the MeanDecreaseGini plot
        varImpPlot(training_fit,type=2, main = "Plot of the MeanDecreaseGini for each attributes for ntree 500")
        
        #Add information to the summary dataframe        
        feature_reduction_summary_df = add_row_to_summary ( feature_reduction_summary_df,
                                                            stock_name,
                                                            "TRUE",
                                                            as.character(sma_df$DateAsDate[1]),
                                                            as.character(sma_df$DateAsDate[nrow(sma_df)]),
                                                            nrow(sma_df),
                                                            removed_missing_values_perc,
                                                            rownames(importance_res)[1], importance_res[1,5],
                                                            rownames(importance_res)[2], importance_res[2,5],
                                                            rownames(importance_res)[3], importance_res[3,5],
                                                            rownames(importance_res)[4], importance_res[4,5], 
                                                            rownames(importance_res)[5], importance_res[5,5],
                                                            rownames(importance_res)[6], importance_res[6,5],
                                                            rownames(importance_res)[7], importance_res[7,5],
                                                            rownames(importance_res)[8], importance_res[8,5],
                                                            rownames(importance_res)[9], importance_res[9,5],
                                                            rownames(importance_res)[10], importance_res[10,5])
        
        #Add trainig and test data to the analysis dataset list 
        analysis_dataset_list[[length(analysis_dataset_list)+1]] <- list(stock_name, "Not Available", "Not Available")

    }
  }
}
cat ("\n")
cat ("Save the Feature Reduciton Summary:\n")
save_to_csv(feature_reduction_summary_df, out_dir,"feature_reduction_summary.csv" )
```

######################################################################### 
######################################################################### 
#######    Test for Normal Distribution    
######################################################################### 
#########################################################################
```{r test_for_normal_distribution}
#Distribution plot (using histogram)  
plot_distribution = function (stock_df, from_date, to_date) {
  stock_name = stock_df$stock_name
  data = stock_df$Log_returns
  h = hist(data, breaks=100, col="red", ylab="Frequency", xlab="Log Returns (%)", 
          main=paste(stock_name, " Log Return Distribution",sep=""), xlim=c(-0.2,0.2)) 
  xfit = seq(min(data),max(data),length=40) 
  yfit = dnorm(xfit,mean=mean(data),sd=sd(data)) 
  yfit = yfit*diff(h$mids[1:2])*length(data) 
  lines(xfit, yfit, col="blue", lwd=2, xlim=c(-0.2,0.2))
  
  kurt = kurtosis(data)
  if(kurt > 0){
      cat("The kurtosis: ", kurt, " > 0 -> the distribution is leptokurtic\n",  sep="")    
  } else if (kurt == 0)
  {
    cat("The kurtosis: ", kurt, " = 0 -> the distribution is mesokurtic\n", sep="")    
  } else {
      cat("The kurtosis: ", kurt, " < 0 -> the distribution is platokurtic\n", sep="")  
  }
  
  skew = skewness(data)
  if(skew > 0){
      cat("The skweness: ", skew, " > 0 -> the distribution is positively Skewed (to the right)\n",  sep="")    
  } else if (skew == 0)
  {
      cat("The skweness: ", skew, " = 0 -> the distribution has no skew\n", sep="")    
  } else {
      cat("The skweness: ", skew, " < 0 -> the distribution is negatively Skewed (to the left)\n", sep="")  
  }
}
?qqline

#Produce a qqplot
plot_qqplot = function (data, stock_name, ylab_param) {
  data = data * 100.0
  title = paste(stock_name, ylab_param, sep =" ")
  qqnorm(data, main=paste(title, " \n (centered & scaled) - QQplot", sep=""), ylab=paste(ylab_param, "(%)", paste=""))
  qqline(data, col="gold", lwd=2)
}

#Produce the results of the KS test
kolmogorov_smirnov_normal_distribution_test = function(data,stock_name,msg) {
  #This is the z-score scaling: (x-avg)/std as default
  scaled_data = scale(data)
  #Ensure all data is unique, else it breaks the ks test
  res = ks.test(unique(scaled_data), pnorm)
  cat(paste(stock_name, msg, sep =" "))
  cat("\n")
  cat("H0 = the data is normally distributed.\n", sep="")
  if(res$p.value > 0.05){
      cat("The ks p_value: ", res$p.value, " > 0.05 -> H0 (the null hypothetsis) is NOT rejected. There is not enough evidence to reject the hypothesis that the distribution is normal. Therefore, the data seems to follow normal distribution\n",  sep="")    
  } else 
  {
      cat("The ks p_value: ", res$p.value, " < 0.05 -> H0 (the null hypothesis) is rejected. The data distribution does not seem to follow a normal distribution.\n",  sep="")    
  }
}

normality_check_df = final_df

for (idx in seq(analysis_dataset_list)) {
  if (idx < max_nb_stocks){
      stock_name = analysis_dataset_list[idx+1][[1]][[1]]
      
      if (length(stock_name)>0){
        cat(stock_name,"\n")
        
        par( mfrow = c( 3, 3 ) )

        ############################ Close_price_1day_lag KS Test ################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_1day_lag)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_1day_lag, stock_name, paste("Check ", stock_name, " 'Close_price_1day_lag/Up' is normally distributed", sep=""))
        plot_qqplot (df$Close_price_1day_lag, stock_name, "Close_price_1day_lag/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_1day_lag)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_1day_lag,stock_name, paste("Check ", stock_name, " 'Close_price_1day_lag/Down' is normally distributed", sep=""))
        plot_qqplot (df$Close_price_1day_lag,stock_name, "Close_price_1day_lag/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_1day_lag)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_1day_lag,stock_name, paste("Check ", stock_name, " 'Close_price_1day_lag/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Close_price_1day_lag,stock_name, "Close_price_1day_lag/Neutral")
        
        ################################### Volume KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Volume)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Volume, stock_name,paste("Check ", stock_name, " 'Volume/Up' is normally distributed",  sep=""))
        plot_qqplot (df$Volume,stock_name, "Volume/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Volume)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Volume,stock_name, paste("Check ", stock_name, " 'Volume/Down' is normally distributed", sep=""))
        plot_qqplot (df$Volume,stock_name, "Volume/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Volume)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Volume,stock_name, paste("Check ", stock_name, " 'Volume/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Volume, stock_name,"Volume/Neutral")
        
        ################################### Close_price_2day_lag KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_2day_lag)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_2day_lag, stock_name,paste("Check ", stock_name, " 'Close_price_2day_lag/Up' is normally distributed", sep=""))
        plot_qqplot (df$Close_price_2day_lag,stock_name, "Close_price_2day_lag/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_2day_lag)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_2day_lag,stock_name, paste("Check ", stock_name, " 'Close_price_2day_lag/Down' is normally distributed", sep=""))
        plot_qqplot (df$Close_price_2day_lag,stock_name, "Close_price_2day_lag/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_2day_lag)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_2day_lag,stock_name, paste("Check ", stock_name, " 'Close_price_2day_lag/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Close_price_2day_lag,stock_name, "Close_price_2day_lag/Neutral")

        
        ################################### Atr_atr KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_atr)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_atr,stock_name, paste("Check ", stock_name, " 'Atr_atr/Up' is normally distributed", sep=""))
        plot_qqplot (df$Atr_atr,stock_name, "Atr_atr/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_atr)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_atr, stock_name,paste("Check ", stock_name, " 'Atr_atr/Down' is normally distributed", sep=""))
        plot_qqplot (df$Atr_atr, stock_name,"Atr_atr/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_atr)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_atr,stock_name, paste("Check ", stock_name, " 'Atr_atr/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Atr_atr,stock_name, "Atr_atr/Neutral")
        
        ################################### Mfi KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Mfi)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Mfi, stock_name,paste("Check ", stock_name, " 'Mfi/Up' is normally distributed", sep=""))
        plot_qqplot (df$Mfi,stock_name, "Mfi/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Mfi)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Mfi,stock_name, paste("Check ", stock_name, " 'Mfi/Down' is normally distributed", sep=""))
        plot_qqplot (df$Mfi,stock_name, "Mfi/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Mfi)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Mfi,stock_name, paste("Check ", stock_name, " 'Mfi/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Mfi, stock_name,"Mfi/Neutral")
  
        
        ################################### Rsi KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Rsi)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Rsi,stock_name, paste("Check ", stock_name, " 'Rsi/Up' is normally distributed", sep=""))
        plot_qqplot (df$Rsi,stock_name, "Rsi/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Rsi)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Rsi, stock_name,paste("Check ", stock_name, " 'Rsi/Down' is normally distributed", sep=""))
        plot_qqplot (df$Rsi,stock_name, "Rsi/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Rsi)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Rsi,stock_name, paste("Check ", stock_name, " 'Rsi/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Rsi, stock_name,"Rsi/Neutral")
        
        
        ################################### Atr_trueLow KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_trueLow)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_trueLow,stock_name, paste("Check ", stock_name, " 'Atr_trueLow/Up' is normally distributed", sep=""))
        plot_qqplot (df$Atr_trueLow,stock_name, "Atr_trueLow/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_trueLow)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_trueLow, stock_name,paste("Check ", stock_name, " 'Atr_trueLow/Down' is normally distributed", sep=""))
        plot_qqplot (df$Atr_trueLow, stock_name,"Atr_trueLow/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_trueLow)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_trueLow,stock_name, paste("Check ", stock_name, " 'Atr_trueLow/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Atr_trueLow,stock_name, "Atr_trueLow/Neutral")
        
        
        ################################### Atr_tr KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_tr)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_tr,stock_name, paste("Check ", stock_name, " 'Atr_tr/Up' is normally distributed", sep=""))
        plot_qqplot (df$Atr_tr,stock_name, "Atr_tr/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_tr)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_tr, stock_name,paste("Check ", stock_name, " 'Atr_tr/Down' is normally distributed", sep=""))
        plot_qqplot (df$Atr_tr, stock_name,"Atr_trLow/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_tr)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_tr,stock_name, paste("Check ", stock_name, " 'Atr_trLow/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Atr_tr,stock_name, "Atr_tr/Neutral")
        
        ################################### Close_price_5day_lag KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_5day_lag)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_5day_lag, stock_name,paste("Check ", stock_name, " 'Close_price_5day_lag/Up' is normally distributed", sep="")) 
        plot_qqplot (df$Close_price_5day_lag,stock_name, "Close_price_5day_lag/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_5day_lag)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_5day_lag,stock_name, paste("Check ", stock_name, " 'Close_price_5day_lag/Down' is normally distributed", sep=""))
        plot_qqplot (df$Close_price_5day_lag,stock_name, "Close_price_5day_lag/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Close_price_5day_lag)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Close_price_5day_lag,stock_name, paste("Check ", stock_name, " 'Close_price_5day_lag/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Close_price_5day_lag,stock_name, "Close_price_5day_lag/Neutral")


        ################################### Atr_trueHigh KS Test ##################################################
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_trueHigh)), Direction == 'Up')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_trueHigh,stock_name, paste("Check ", stock_name, " 'Atr_trueHigh/Up' is normally distributed", sep=""))
        plot_qqplot (df$Atr_trueHigh,stock_name, "Atr_trueHigh/Up")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_trueHigh)), Direction == 'Down')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_trueHigh, stock_name,paste("Check ", stock_name, " 'Atr_trueHigh/Down' is normally distributed", sep=""))
        plot_qqplot (df$Atr_trueHigh, stock_name,"Atr_trueLow/Down")
        
        df =  subset(subset(normality_check_df, select=c(Direction,Atr_trueHigh)), Direction == 'Neutral')
        kolmogorov_smirnov_normal_distribution_test(df$Atr_trueHigh,stock_name, paste("Check ", stock_name, " 'Atr_trueHigh/Neutral' is normally distributed", sep=""))
        plot_qqplot (df$Atr_trueHigh,stock_name, "Atr_trueHigh/Neutral")
        
    }
  }
}

par( mfrow = c( 1, 1 ) ) 

```


############################################################################### 
###############################################################################
#######     Model Training, Optimisation (hyperparameters tuning) & Testing   
############################################################################### 
###############################################################################
```{r tree_model_training}

#Model comparison Summary
model_comparison_summary_df = data.frame( uuid = "",
                                          stock_name= "",
                                          model_run_success ="",
                                          aggregation_type= "",
                                          model_name= "", model_desc= "", model_type="",
                                          model_accuracy_rate ="", model_error_rate="",
                                          stringsAsFactors=FALSE)

#the test_data_param could be a traning/validation or test dataset
run_lda_model = function(fit_param, uuid, stock_name, model_name, model_desc, model_type, model_comparison_summary_df, test_data_param, save_confusion_matrix=FALSE){
  
    lda.fit = fit_param

    #Generate the confusion matrix and calculate the training/validation error rate
    lda.pred = predict(lda.fit, test_data_param)$class
    lda.confusion_table =  table(lda.pred, test_data_param$Direction)
    lda.accuracy_rate = accuracy_rate_perc(lda.confusion_table)
    lda.error_rate = error_rate_perc(lda.confusion_table)

    #Add a row in the model comparison dataframe        
    model_comparison_summary_df <<- add_row_to_model_summary( model_comparison_summary_df,
                                                              uuid,
                                                              stock_name,
                                                              "TRUE",
                                                              "",
                                                              model_name, model_desc,model_type,
                                                              lda.accuracy_rate, lda.error_rate)
    if (save_confusion_matrix == TRUE){    
      
      save_to_csv(lda.confusion_table, out_dir,paste("lda_confusion_matrix_", UUIDgenerate() ,".csv",sep=""))
    }
    
    return (model_comparison_summary_df)
}

run_qda_model = function(fit_param, uuid, stock_name, model_name, model_desc,model_type, model_comparison_summary_df,test_data_param, save_confusion_matrix=FALSE){
  
    qda.fit = fit_param

    #Generate the confusion matrix and calculate the training/validation error rate
    qda.pred = predict(qda.fit, test_data_param)$class
    qda.confusion_table =  table(qda.pred, test_data_param$Direction)
    qda.accuracy_rate = accuracy_rate_perc(qda.confusion_table)
    qda.error_rate = error_rate_perc(qda.confusion_table)

    #Add a row in the model comparison dataframe        
    model_comparison_summary_df <<- add_row_to_model_summary( model_comparison_summary_df,
                                                              uuid,
                                                              stock_name,
                                                              "TRUE",
                                                              "",
                                                              model_name, model_desc,model_type,
                                                              qda.accuracy_rate, qda.error_rate)
    
    if (save_confusion_matrix == TRUE){
      save_to_csv(qda.confusion_table, out_dir,paste("qda_confusion_matrix_", UUIDgenerate() ,".csv",sep=""))
    }
    
    return (model_comparison_summary_df)
}
      
#the test_data_param could be a traning/validation or test dataset
run_svm_model = function(svm_param, uuid, stock_name, model_name, model_desc, model_type, model_comparison_summary_df, test_data_param){
  
    svm.fit = svm_param

    #Generate the confusion matrix and calculate the training/validation error rate
    #decision.values = TRUE, probability = TRUE are necessary when multi class probabilities are required
    pred_prob = predict(svm.fit, test_data_param, decision.values = TRUE, probability = TRUE)
    #Get the class probabilities
    pred_prob_attr = attr(pred_prob, "probabilities")
    #Get the most probable class per row 
    pred_class_as_factor = apply(pred_prob_attr, 1, which.max)
    pred_class_as_name = pred_class_as_factor
    #Get the name of each class
    col_name =  colnames(attr(pred_prob, "probabilities"))
    index = 1
    map = NULL
    #Create a list  that map an index to a class name
    for (cn in col_name){
        map = append(map,list(id = index, name = cn)) 
        index =index +1
    }
    #Find the predicted class name, given the predicted class factor, from the map list 
    index = 1
    for(class_as_factor in pred_class_as_factor){
      pos = match(class_as_factor,map)
      pred_class_as_name[index] = map[pos+1]
      index = index +1
    }
    #Generate a dataframe for the predicted class names
    svm.pred_class_as_name_df = data.frame(matrix(unlist(pred_class_as_name)),stringsAsFactors=FALSE)
    #Generate the confusion matrix
    svm.confusion_table =  table(svm.pred_class_as_name_df$matrix.unlist.pred_class_as_name.., test_data_param$Direction)
    svm.accuracy_rate = accuracy_rate_perc(svm.confusion_table)
    svm.error_rate = error_rate_perc(svm.confusion_table)

    #Add a row in the model comparison dataframe        
    model_comparison_summary_df <<- add_row_to_model_summary( model_comparison_summary_df,
                                                              uuid,
                                                              stock_name,
                                                              "TRUE",
                                                              "",
                                                              model_name, model_desc,model_type,
                                                              svm.accuracy_rate, svm.error_rate)
    
    return (model_comparison_summary_df)
}

run_tree_model = function(fit_param,uuid, stock_name, model_name, model_desc,model_type, model_comparison_summary_df,test_data_param, can_prune=TRUE){
  
    set.seed(1)
  
    tree.fit = fit_param
    #Type="class" is selected as we are dealing with a classification problem
    tree.pred = predict(tree.fit, test_data_param, type="class")

    #Generate the confusion matrix and calculate the training/validation error rate
    tree.confusion_table =  table(tree.pred, test_data_param$Direction)
    tree.accuracy_rate = accuracy_rate_perc(tree.confusion_table)
    tree.error_rate = error_rate_perc(tree.confusion_table)

    #Add a row in the model comparison dataframe        
    model_comparison_summary_df <<- add_row_to_model_summary( model_comparison_summary_df,
                                                              uuid,
                                                              stock_name,
                                                              "TRUE",
                                                              "",
                                                              model_name, model_desc,model_type,
                                                              tree.accuracy_rate, tree.error_rate)
    
    return (model_comparison_summary_df)
}


run_boosting_model = function(fit_param, uuid, n_trees_param, stock_name, model_name, model_desc,model_type, model_comparison_summary_df,test_data_param){

  set.seed(1)

  boost.fit = fit_param
  
  #Geneate the model prediction. Type=response returns the class prediction as probability
  boost.pred = predict(boost.fit, test_data_param, n.trees = n_trees_param, type="response")

  #We know need to find the most probable class (the class showing the highest probability) for each row of the boost.pred
  #see http://stackoverflow.com/questions/29454883/in-gbm-multinomial-dist-how-to-use-predict-to-get-categorical-output
  boost.proba = apply(boost.pred, 1, which.max)
  #And now turn the class id (1,2 or 3) into the class name
  boost.pred_class = colnames(boost.pred)[boost.proba]
  #necessary as a non-compatible skrinkage could generate unpredictable classes
  boost.accuracy_rate = "NA"
  boost.error_rate = "NA"
  if (length(boost.pred_class) > 0){
    boost.confusion_table =  table(boost.pred_class, test_data_param$Direction)
    boost.accuracy_rate = accuracy_rate_perc(boost.confusion_table)
    boost.error_rate = error_rate_perc(boost.confusion_table)
  }
  
  #Add a row in the model comparison dataframe        
  model_comparison_summary_df <<- add_row_to_model_summary( model_comparison_summary_df,
                                                            uuid,
                                                            stock_name,
                                                            "TRUE",
                                                            "",
                                                            model_name, model_desc,model_type,
                                                            boost.accuracy_rate, boost.error_rate)
  
  
  return (model_comparison_summary_df)
}

run_rdmForest_model = function(fit_param, n_trees_param, uuid, stock_name, model_name, model_desc,model_type, model_comparison_summary_df,data_param){

  set.seed(1)

  rdmForest.fit = fit_param
  
  #Geneate the model prediction.
  rdmForest.pred = predict(rdmForest.fit, data_param, n.trees = n_trees_param, type="response")

  #Generate the confusion matrix and calculate the classification error rate on the test/valdation data
  rdmForest.confusion_table =  table(rdmForest.pred, data_param$Direction)
  rdmForest.accuracy_rate = accuracy_rate_perc(rdmForest.confusion_table)
  rdmForest.error_rate = error_rate_perc(rdmForest.confusion_table)

  #Add a row in the model comparison dataframe        
  model_comparison_summary_df <<- add_row_to_model_summary( model_comparison_summary_df,
                                                            uuid,
                                                            stock_name,
                                                            "TRUE",
                                                            "",
                                                            model_name, model_desc,model_type,
                                                            rdmForest.accuracy_rate, rdmForest.error_rate)
  return (model_comparison_summary_df)
}

run_mlr_model = function(colum_list, alpha_param, lambda_param, uuid, stock_name, model_name, model_desc,model_type, model_comparison_summary_df,training_data_param, test_data_param){

  set.seed(1)

  #Seleted the necessary columns for the training and test set 
  mlr_training_data = training_data_param[columns]
  mlr_test_data = test_data_param[columns]

  #Get the list of attributes col names
  col_names = colnames(mlr_training_data[-1])
  #Create a model for each set
  training_model = sparse.model.matrix( as.formula(paste("Direction ~", paste(col_names, sep = "", collapse=" +"))), 
                                        data = mlr_training_data)
  test_model = sparse.model.matrix( as.formula(paste("Direction ~", paste(col_names, sep = "", collapse=" +"))), 
                                         data = mlr_test_data)

  mlr_fit = glmnet(training_model[1:nrow(mlr_training_data),], mlr_training_data$Direction, family = "multinomial", alpha=alpha_param)
  
  #Geneate the model prediction depending on the lambda level
  if (is.null(lambda_param)) {
    lambda_param = min(mlr_fit$lambda)
  }
  mlr.pred = predict(mlr_fit,as.matrix(test_model), type="class",s=lambda_param)

  #Generate the confusion matrix and calculate the classification error rate on the test/valdation data
  mlr.confusion_table =  table(mlr.pred, test_data_param$Direction)
  mlr.accuracy_rate = accuracy_rate_perc(mlr.confusion_table)
  mlr.error_rate = error_rate_perc(mlr.confusion_table)

  #Add a row in the model comparison dataframe        
  model_comparison_summary_df <<- add_row_to_model_summary( model_comparison_summary_df,
                                                            uuid,
                                                            stock_name,
                                                            "TRUE",
                                                            "",
                                                            model_name, model_desc,model_type,
                                                            mlr.accuracy_rate, mlr.error_rate)
  
  
  
  return (model_comparison_summary_df)
}


  
#Add model that failed into model_comparison_summary_df
add_failed_model = function (model_comparison_summary_df,uuid, stock_name, model_name, model_desc,model_type, possibleError){

    if(inherits(possibleError, "error")){
            model_comparison_summary_df <<- add_row_to_model_summary(  model_comparison_summary_df,
                                                                       uuid,
                                                                       stock_name,
                                                                       "FALSE",
                                                                       "",
                                                                       model_name, model_desc,model_type,
                                                                       0, 0)
  }
}

#Add model avg values into model_comparison_summary_df
add_avg_model = function (model_comparison_summary_df, uuid, stock_name, model_name, model_desc, model_type, accuracy_rate, error_rate){

        model_comparison_summary_df <<- add_row_to_model_summary(  model_comparison_summary_df,
                                                                   uuid,
                                                                  stock_name,
                                                                  "TRUE",
                                                                  "AVG",
                                                                  model_name, model_desc,model_type,
                                                                  accuracy_rate, error_rate)
}

#Calculate the avg accuracy and error rate across all time windows  
generate_avg_model = function( model_comparison_summary_df,uuid_param, time_window_seq, model_type ){
  #sub_df  = model_comparison_summary_df[ which( model_comparison_summary_df$uuid == uuid_param && is.numeric(model_comparison_summary_df$model_accuracy_rate )), ]
  #avg_accuracy_rate = sum(as.numeric(sub_df$model_accuracy_rate), na.rm = TRUE)/as.numeric(length(sub_df))
  #avg_error_rate = sum(as.numeric(sub_df$model_error_rate))/as.numeric(length(sub_df))
  #add_avg_model(model_comparison_summary_df, uuid_param, stock_name, model_name, model_desc,model_type, avg_accuracy_rate, avg_error_rate)
  
  #Get a subset of the dataset for the uuid in question
  sub_df  = model_comparison_summary_df[ which( model_comparison_summary_df$uuid == uuid_param ), ]
  #Remove any rows with non numeric accuracy rate
  sub_df = sub_df[!is.na(as.numeric(as.character(sub_df$model_accuracy_rate))),]
  #Start the calc from here
  count = as.numeric(dim(sub_df)[1])
  avg_accuracy_rate = sum(as.numeric(sub_df$model_accuracy_rate), na.rm = TRUE)/count
  avg_error_rate = sum(as.numeric(sub_df$model_error_rate))/count
  add_avg_model(model_comparison_summary_df, uuid_param, stock_name, model_name, model_desc,model_type, avg_accuracy_rate, avg_error_rate)
}

#Get the sequence index of time windows
time_window_seq = seq(dim(time_window_df)[1])

#For each stock in the analysis dataset list, get its name and training/test datasets.
#Then compute the test performance for each selected models
#Finally, append the results into model comparison summary dataframe
for (idx in seq(analysis_dataset_list)) {
  set.seed(1)
  if (idx < max_nb_stocks){
      stock_name = analysis_dataset_list[idx+1][[1]][[1]]
      
      if (length(stock_name)>0){
        cat(stock_name,"\n")
        
         #########################################################################
         #########################################################################
         #######   The Ridge Model - Model Training
         #########################################################################
         #########################################################################
        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr","Close_price_5day_lag","Atr_trueHigh")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr","Close_price_5day_lag")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow "
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()

       for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()


         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()


         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr")

           possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()

       for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag")

           possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag","Volume")

           possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Ridge"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag"
        model_type = "TRAIN"
        the_alpha = 0
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag")

           possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

         #########################################################################
         #########################################################################
         #######   The Ridge Model - Model Optimisation
         #########################################################################
         #########################################################################

        lambda_list = c(0.0001, 0.0005, 0.0010,0.0015,0.0020,0.0050, 0.0055, 0.0060, 0.01, 0.02, 0.03, 0.04, 0.5,1)

         #The optimisation is performed on the last sliding window
         for (the_lambda in lambda_list){
            model_name = "Ridge"
            model_desc = paste( "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | lambda = ", toString(the_lambda),sep="")
           model_type = "OPTIMISATION"
           the_alpha = 0
           uuid = UUIDgenerate()

           #Get the Training and Validation data for the given time window
           training_range = time_window_df[number_sliding_windows,"training_start_index"]:time_window_df[number_sliding_windows,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[number_sliding_windows,"validation_start_index"]:time_window_df[number_sliding_windows,"validation_end_index"]
           validation_data = final_df[validation_range,]

            columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr",
                        "Close_price_5day_lag","Atr_trueHigh")

            possibleError = tryCatch( run_mlr_model(columns, the_alpha, the_lambda, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
            add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
         }

          #########################################################################
          #########################################################################
          #######   The Ridge Model - Model Testing
          #########################################################################
          #########################################################################
         model_name = "Ridge"
         the_lambda = 0.001
         model_desc = paste( "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | lambda = ", toString(the_lambda),sep="")
         model_type = "TEST"
         the_alpha = 0
         uuid = UUIDgenerate()

         #This time the model is tained on the Traning + Validation data, then it is tested against the Testing data.
         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
           training_data = final_df[training_range,]
           test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
           test_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr",
                      "Close_price_5day_lag","Atr_trueHigh")

            possibleError = tryCatch( run_mlr_model(columns, the_alpha, the_lambda, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
            add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
         }
         generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))

        
         #########################################################################
         #########################################################################
         #######   The Lasso Model - Model Training
         #########################################################################
         #########################################################################
        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr","Close_price_5day_lag","Atr_trueHigh")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr","Close_price_5day_lag")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow "
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()

       for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()


         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

          columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi")

          possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()


         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr")

           possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()

       for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag")

           possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag","Volume")

           possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Lasso"
        model_desc = "Direction ~ Direction ~ Close_price_1day_lag"
        model_type = "TRAIN"
        the_alpha = 1
        uuid = UUIDgenerate()

         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
           validation_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag")

           possibleError = tryCatch( run_mlr_model(columns, the_alpha, NULL, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

         #########################################################################
         #########################################################################
         #######   The Lasso Model - Model Optimisation
         #########################################################################
         #########################################################################

        lambda_list = c(0.0001, 0.0005, 0.0010,0.0015,0.0020,0.0050, 0.0055, 0.0060, 0.01, 0.02, 0.03, 0.04, 0.5,1)

         #The optimisation is performed on the last sliding window
         for (the_lambda in lambda_list){
            model_name = "Lasso"
            model_desc = paste( "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr | lambda = ", toString(the_lambda),sep="")
           model_type = "OPTIMISATION"
           the_alpha = 1
           uuid = UUIDgenerate()

           #Get the Training and Validation data for the given time window
           training_range = time_window_df[number_sliding_windows,"training_start_index"]:time_window_df[number_sliding_windows,"training_end_index"]
           training_data = final_df[training_range,]
           validation_range = time_window_df[number_sliding_windows,"validation_start_index"]:time_window_df[number_sliding_windows,"validation_end_index"]
           validation_data = final_df[validation_range,]

            columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr")

            possibleError = tryCatch( run_mlr_model(columns, the_alpha, the_lambda, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
            add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
         }

         #########################################################################
         #########################################################################
         #######   The Lasso Model - Model Testing
         #########################################################################
         #########################################################################
         model_name = "Lasso"
         the_alpha = 1
         the_lambda = 0.005
         model_desc = paste( "Direction ~ Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | lambda = ", toString(the_lambda),sep="")
         model_type = "TEST"
         uuid = UUIDgenerate()

         #This time the model is tained on the Traning + Validation data, then it is tested against the Testing data.
         for (tw_index in time_window_seq){
           #Get the Training and Validation data for the given time window
           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
           training_data = final_df[training_range,]
           test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
           test_data = final_df[validation_range,]

           columns = c("Direction","Close_price_1day_lag","Volume","Close_price_2day_lag","Atr_atr","Mfi","Rsi","Atr_trueLow","Atr_tr",
                      "Close_price_5day_lag","Atr_trueHigh")

            possibleError = tryCatch( run_mlr_model(columns, the_alpha, the_lambda, uuid, stock_name, model_name, model_desc,model_type,
                                                  model_comparison_summary_df,training_data, validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
            add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
         }
         generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))
 
    
        #########################################################################
        #########################################################################
        #######   Linear Descriminent Analysis (LDA) - Model Training
        #########################################################################
        #########################################################################

        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow +
                                               Atr_tr +
                                               Close_price_5day_lag +
                                               Atr_trueHigh,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow +
                                               Atr_tr +
                                               Close_price_5day_lag,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)



        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow +
                                               Atr_tr,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction  ~ Close_price_1day_lag +
                                               Volume,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          lda_fit =  lda (Direction ~ Close_price_1day_lag,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid,time_window_seq,model_type)


        # model_name = "Linear Descriminent Analysis (LDA)"
        # model_desc = "Direction ~  Close_price_1day_lag^3 + Volume^2 + Close_price_1day_lag + Volume + (Atr_atr * Mfi) + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        # model_type = "TRAIN"
        # uuid = UUIDgenerate()
        #
        # for (tw_index in time_window_seq){
        #   #Get the Training and Validation data for the given time window
        #   training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
        #   training_data = final_df[training_range,]
        #   validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
        #   validation_data = final_df[validation_range,]
        #
        #   lda_fit =  lda (Direction ~ Close_price_1day_lag^3 +
        #                                        Volume^2 +
        #                                        Close_price_1day_lag +
        #                                        Volume, (Atr_atr * Mfi) +
        #                                        Atr_atr +
        #                                        Mfi +
        #                                        Rsi +
        #                                        Atr_trueLow +
        #                                        Atr_tr +
        #                                        Close_price_5day_lag +
        #                                        Atr_trueHigh,
        #                               data=training_data)
        #
        #   possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
        #                            error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
        #   add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type,possibleError)
        # }
        # generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        #########################################################################
        #########################################################################
        #######   Linear Descriminent Analysis (LDA) - Model Testing
        #########################################################################
        #########################################################################

        model_name = "Linear Descriminent Analysis (LDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TEST"
        uuid = UUIDgenerate()

        #This time the model is tained on the Traning + Validation data, then it is tested against the Testing data.
        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
          training_data = final_df[training_range,]
          test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
          test_data = final_df[validation_range,]

          lda_fit =  lda (Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr +
                                      Mfi +
                                      Rsi +
                                      Atr_trueLow +
                                      Atr_tr,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(lda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,test_data, TRUE),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))

        #########################################################################
        #########################################################################
        #######   Quadratic Descriminent Analysis (QDA) - Model Training
        #########################################################################
        #########################################################################

        # model_name = "Quadratic Descriminent Analysis (QDA)"
        # model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        # model_type = "TRAIN"
        # uuid = UUIDgenerate()
        #
        # for (tw_index in time_window_seq){
        #   #Get the Training and Validation data for the given time window
        #   training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
        #   training_data = final_df[training_range,]
        #   validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
        #   validation_data = final_df[validation_range,]
        #
        #   qda_fit =  qda (Direction ~ Close_price_1day_lag +
        #                                        Volume +
        #                                        Close_price_2day_lag +
        #                                        Atr_atr +
        #                                        Mfi +
        #                                        Rsi +
        #                                        Atr_trueLow +
        #                                        Atr_tr +
        #                                        Close_price_5day_lag +
        #                                        Atr_trueHigh,
        #                     data=training_data)
        #
        #   possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
        #                            error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
        #   add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        # }
        # generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow +
                                               Atr_tr +
                                               Close_price_5day_lag,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow +
                                               Atr_tr,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi,
                            data=training_data)

          possibleError = tryCatch( run_lda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction  ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction  ~ Close_price_1day_lag +
                                               Volume,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          qda_fit =  qda (Direction ~ Close_price_1day_lag,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid,time_window_seq,model_type)


        # model_name = "Quadratic Descriminent Analysis (QDA)"
        # model_desc = "factor(Direction) ~  Close_price_1day_lag^3 + Volume^2 + Close_price_1day_lag + Volume + (Atr_atr * Mfi) + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        # model_type = "TRAIN"
        # uuid = UUIDgenerate()
        #
        # for (tw_index in time_window_seq){
        #   #Get the Training and Validation data for the given time window
        #   training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
        #   training_data = final_df[training_range,]
        #   validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
        #   validation_data = final_df[validation_range,]
        #
        #   qda_fit =  qda (Direction ~ Close_price_1day_lag^3 +
        #                                        Volume^2 +
        #                                        Close_price_1day_lag +
        #                                        Volume, (Atr_atr * Mfi) +
        #                                        Atr_atr +
        #                                        Mfi +
        #                                        Rsi +
        #                                        Atr_trueLow +
        #                                        Atr_tr +
        #                                        Close_price_5day_lag +
        #                                        Atr_trueHigh,
        #                               data=training_data)
        #
        #   possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
        #                            error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
        #   add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type,possibleError)
        # }
        # generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        #########################################################################
        #########################################################################
        #######   Quadratic Descriminent Analysis (QDA) - Model Testing
        #########################################################################
        #########################################################################

        model_name = "Quadratic Descriminent Analysis (QDA)"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TEST"
        uuid = UUIDgenerate()

        #This time the model is tained on the Traning + Validation data, then it is tested against the Testing data.
        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
          training_data = final_df[training_range,]
          test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
          test_data = final_df[validation_range,]

          qda_fit =  qda (Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr +
                                      Mfi +
                                      Rsi +
                                      Atr_trueLow +
                                      Atr_tr +
                                      Close_price_5day_lag,
                            data=training_data)

          possibleError = tryCatch( run_qda_model(qda_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,test_data, TRUE),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))

        #########################################################################
        #########################################################################
        #######             Boosting Model
        #########################################################################
        #########################################################################

        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr +
                                      Mfi +
                                      Rsi +
                                      Atr_trueLow +
                                      Atr_tr +
                                      Close_price_5day_lag +
                                      Atr_trueHigh,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr +
                                      Mfi +
                                      Rsi +
                                      Atr_trueLow +
                                      Atr_tr +
                                      Close_price_5day_lag,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr +
                                      Mfi +
                                      Rsi +
                                      Atr_trueLow +
                                      Atr_tr,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr +
                                      Mfi +
                                      Rsi +
                                      Atr_trueLow,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr +
                                      Mfi +
                                      Rsi,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr +
                                      Mfi,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag +
                                      Atr_atr,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume +
                                      Close_price_2day_lag,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Boosting"
        model_desc = "Direction ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                      Volume,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        # model_name = "Boosting"
        # model_desc = "Direction ~ Close_price_1day_lag"
        # model_type = "TRAIN"
        # uuid = UUIDgenerate()
        # n_trees = 500
        #
        # for (tw_index in time_window_seq){
        #   #Get the Training and Validation data for the given time window
        #   training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
        #   training_data = final_df[training_range,]
        #   validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
        #   validation_data = final_df[validation_range,]
        #
        #   #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
        #   #The gbm() function fit the Direction variable against all other selected predictors on the training set.
        #   boost_fit = gbm(Direction ~ Close_price_1day_lag
        #                 ,data = training_data, distribution = "multinomial", n.trees = n_trees)
        #
        #
        #   possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
        #                                                 n_trees,stock_name,
        #                                                 model_name,model_desc,
        #                                                 model_type,model_comparison_summary_df,
        #                                                 validation_data),
        #                            error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
        #   add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        # }
        # generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Boosting"
        model_desc = "factor(Direction) ~  Close_price_1day_lag^3 + Volume^2 + Close_price_1day_lag + Volume + (Atr_atr * Mfi) + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        n_trees = 500

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          #This is a mutinominal classification problem. Therefore, the distribution is set to "multinomial".
          #The gbm() function fit the Direction variable against all other selected predictors on the training set.
          boost_fit = gbm(Direction ~  Close_price_1day_lag^3 +
                                       Volume^2 +
                                       Close_price_1day_lag +
                                       Volume, (Atr_atr * Mfi) +
                                       Atr_atr +
                                       Mfi +
                                       Rsi +
                                       Atr_trueLow +
                                       Atr_tr +
                                       Close_price_5day_lag +
                                       Atr_trueHigh,
                        data = training_data, distribution = "multinomial", n.trees = n_trees)

          possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                        n_trees,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        #########################################################################
        #########################################################################
        #######             Boosting Optimisation
        #########################################################################
        #########################################################################
        #The optimisation is performed on the last sliding window
        training_range = time_window_df[number_sliding_windows,"training_start_index"]:time_window_df[number_sliding_windows,"training_end_index"]
        training_data = final_df[training_range,]
        validation_range = time_window_df[number_sliding_windows,"validation_start_index"]:time_window_df[number_sliding_windows,"validation_end_index"]
        validation_data = final_df[validation_range,]

        tree_list = c (500,1000,1500,2000,3000,5000)
        #Generate a vector of sequence of staring from 0.1 and going to 1.0, with a 0.1 step
        lambdas = seq(0.1, 1, by = 0.1)
        len = length(lambdas)
        for (the_tree in tree_list){
          for (i in 1:len) {
            model_name = "Boosting"
            model_desc = paste("Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr | n_trees =", the_tree, " |  shrinkage =", lambdas[i] , sep= " ")
            model_type = "OPTIMISATION"
            uuid = UUIDgenerate()

            boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                        Volume +
                                        Close_price_2day_lag +
                                        Atr_atr +
                                        Mfi +
                                        Rsi +
                                        Atr_trueLow +
                                        Atr_tr
                          ,data = training_data, distribution = "multinomial", n.trees = the_tree, shrinkage = lambdas[i])

            possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                          n_trees,stock_name,
                                                          model_name,model_desc,
                                                          model_type,model_comparison_summary_df,
                                                          validation_data),
                                     error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
            add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
          }
        }

        #########################################################################
        #########################################################################
        #######             Boosting Model - Testing
        #########################################################################
        #########################################################################
        n_trees = 500
        the_lambda = 0.1
        model_name = "Boosting"
        model_desc = paste("Direction ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr | n_trees =", the_tree, " |  shrinkage =", the_lambda , sep= " ")

        model_type = "TEST"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
          training_data = final_df[training_range,]
          test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
          test_data = final_df[test_range,]

            boost_fit = gbm(Direction ~ Close_price_1day_lag +
                                        Volume +
                                        Close_price_2day_lag +
                                        Atr_atr +
                                        Mfi +
                                        Rsi +
                                        Atr_trueLow +
                                        Atr_tr
                          ,data = training_data, distribution = "multinomial", n.trees = n_trees, shrinkage = the_lambda)

            possibleError = tryCatch( run_boosting_model(  boost_fit,uuid,
                                                          n_trees,stock_name,
                                                          model_name,model_desc,
                                                          model_type,model_comparison_summary_df,
                                                          test_data),
                                     error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
            add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))


        #########################################################################
        #########################################################################
        #######   Decision Tree - Model Training
        #########################################################################
        #########################################################################
        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow +
                                               Atr_tr +
                                               Close_price_5day_lag +
                                               Atr_trueHigh,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow +
                                               Atr_tr +
                                               Close_price_5day_lag,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow +
                                               Atr_tr,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi +
                                               Atr_trueLow,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi +
                                               Rsi,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr +
                                               Mfi,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag +
                                               Atr_atr,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume +
                                               Close_price_2day_lag,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                               Volume,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Decision Tree"
        model_desc = "factor(Direction) ~ Close_price_1day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag,
                            data=training_data)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        # model_name = "Decision Tree"
        # model_desc = "factor(Direction) ~  Close_price_1day_lag^3 + Volume^2 + Close_price_1day_lag + Volume + (Atr_atr * Mfi) + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        # model_type = "TRAIN"
        # uuid = UUIDgenerate()
        #
        # for (tw_index in time_window_seq){
        #   #Get the Training and Validation data for the given time window
        #   training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
        #   training_data = final_df[training_range,]
        #   validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
        #   validation_data = final_df[validation_range,]
        #
        #   tree_fit =  tree (factor(Direction) ~  Close_price_1day_lag^3 +
        #                                          Volume^2 +
        #                                          Close_price_1day_lag +
        #                                          Volume +
        #                                         (Atr_atr * Mfi) +
        #                                         Atr_atr +
        #                                         Mfi +
        #                                         Rsi +
        #                                         Atr_trueLow +
        #                                         Atr_tr +
        #                                         Close_price_5day_lag +
        #                                         Atr_trueHigh,
        #                     data=training_data)
        #
        #   possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
        #                            error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
        #   add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        # }
        # generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        #########################################################################
        #########################################################################
        #######   Decision Tree - Model Optimisation
        #########################################################################
        #########################################################################

        min_size_list = c(1,2,5,10,20,40,60,80,100)

        #The optimisation is performed on the last sliding window
        for (the_min_size in min_size_list){
          model_name = "Decision Tree"
          model_desc = paste( "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | min size = ", toString(the_min_size),sep="")
          model_type = "OPTIMISATION"
          uuid = UUIDgenerate()

          #Get the Training and Validation data for the given time window
          training_range = time_window_df[number_sliding_windows,"training_start_index"]:time_window_df[number_sliding_windows,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[number_sliding_windows,"validation_start_index"]:time_window_df[number_sliding_windows,"validation_end_index"]
          validation_data = final_df[validation_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                                Volume +
                                                Close_price_2day_lag +
                                                Atr_atr +
                                                Mfi +
                                                Rsi +
                                                Atr_trueLow +
                                                Atr_tr +
                                                Close_price_5day_lag +
                                                Atr_trueHigh,
                            data=training_data)


          tree.pruned = prune.misclass(tree_fit, best = the_min_size)

          possibleError = tryCatch( run_tree_model(tree.pruned,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }

        #########################################################################
        #########################################################################
        #######   Decision Tree - Model Testing
        #########################################################################
        #########################################################################

        #the_min_size = 2
        model_name = "Decision Tree"
        model_desc = "Direction ~ Close_price_1day_lag + Close_price_4day_lag + Close_price_2day_lag + Atr_trueHigh"
        model_type = "TEST"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
          training_data = final_df[training_range,]
          test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
          test_data = final_df[test_range,]

          tree_fit =  tree (factor(Direction) ~ Close_price_1day_lag +
                                      Close_price_4day_lag +
                                      Close_price_2day_lag +
                                      Atr_trueHigh,
                            data=training_data)

          #tree.pruned = prune.misclass(tree_fit, best = the_min_size)

          possibleError = tryCatch( run_tree_model(tree_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,test_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))

        #########################################################################
        #########################################################################
        #######             Bagging Model
        ######  Specialised Random Forest where mtry = p (number of attributes)
        #########################################################################
        #########################################################################
        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=10

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr +
                                                           Close_price_5day_lag +
                                                           Atr_trueHigh,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=9

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr +
                                                           Close_price_5day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=8

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=7

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=6

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=5

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=4

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]


          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=3

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)


          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=2

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)


          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Bagging"
        model_desc = "factor(Direction) ~ Close_price_1day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=1

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


#         model_name = "Bagging"
# model_desc = "factor(Direction) ~  Close_price_1day_lag^3 + Volume^2 + Close_price_1day_lag + Volume + (Atr_atr * Mfi) + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
#         model_type = "TRAIN"
#         uuid = UUIDgenerate()
#         m_try = 12
# 
#         for (tw_index in time_window_seq){
#           #Get the Training and Validation data for the given time window
#           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
#           training_data = final_df[training_range,]
#           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
#           validation_data = final_df[validation_range,]
# 
#           bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag^3 +
#                                                          Volume^2 +
#                                                          Close_price_1day_lag +
#                                                          Volume, (Atr_atr * Mfi) +
#                                                          Atr_atr +
#                                                          Mfi +
#                                                          Rsi +
#                                                          Atr_trueLow +
#                                                          Atr_tr +
#                                                          Close_price_5day_lag +
#                                                          Atr_trueHigh,
#                                        data=training_data,
#                                        mtry=m_try,
#                                        importance=TRUE)
# 
#           possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
#                                                         uuid,stock_name,
#                                                         model_name,model_desc,
#                                                         model_type,model_comparison_summary_df,
#                                                         validation_data),
#                                    error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
#           add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
#         }
#         generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        #########################################################################
        #########################################################################
        #######             Bagging Model - Optimisation
        ######  Specialised Random Forest where mtry = p (number of attributes)
        #########################################################################
        #########################################################################
        n_trees_list = c(500,1000,2000,3000,4000, 5000)

        for (n_trees in n_trees_list){
          model_name = "Bagging"
          model_desc = paste("factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow | ntrees = ", n_trees, paste="")
          model_type = "OPTIMISATION"
          uuid = UUIDgenerate()
          m_try=7

          #Get the Training and Validation data for the given time window
          training_range = time_window_df[number_sliding_windows,"training_start_index"]:time_window_df[number_sliding_windows,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[number_sliding_windows,"validation_start_index"]:time_window_df[number_sliding_windows,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag +
                                                          Volume +
                                                          Close_price_2day_lag +
                                                          Atr_atr +
                                                          Mfi +
                                                          Rsi +
                                                          Atr_trueLow,
                                       data=training_data,
                                       ntree=n_trees,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)

        }

#         #########################################################################
#         #########################################################################
#         #######             Bagging Model - Testing
#         ######  Specialised Random Forest where mtry = p (number of attributes)
#         #########################################################################
#         #########################################################################

        n_trees = 500
        model_name = "Bagging"
        model_desc = paste("factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow  | ntrees = ", n_trees, paste="")
        model_type = "TEST"
        uuid = UUIDgenerate()
        m_try=7

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
          training_data = final_df[training_range,]
          test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
          test_data = final_df[test_range,]

          bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag +
                                                          Volume +
                                                          Close_price_2day_lag +
                                                          Atr_atr +
                                                          Mfi +
                                                          Rsi +
                                                          Atr_trueLow,
                                       data=training_data,
                                       ntree=n_trees,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        test_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))


        #########################################################################
        #########################################################################
        #######             Random Forest Model
        ######              mtry approx equal to SQRT(p)
        #########################################################################
        #########################################################################
        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=3

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr +
                                                           Close_price_5day_lag +
                                                           Atr_trueHigh,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=3

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr +
                                                           Close_price_5day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=3

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=3

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=2

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=2

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=2

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]


          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=2

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)


          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=1

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)


          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = "factor(Direction) ~ Close_price_1day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=1

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


#         model_name = "Random Forest (mtry = SQRT(p))"
# model_desc = "factor(Direction) ~  Close_price_1day_lag^3 + Volume^2 + Close_price_1day_lag + Volume + (Atr_atr * Mfi) + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
#         model_type = "TRAIN"
#         uuid = UUIDgenerate()
#         m_try = 3
#
#         for (tw_index in time_window_seq){
#           #Get the Training and Validation data for the given time window
#           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
#           training_data = final_df[training_range,]
#           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
#           validation_data = final_df[validation_range,]
#
#           bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag^3 +
#                                                          Volume^2 +
#                                                          Close_price_1day_lag +
#                                                          Volume, (Atr_atr * Mfi) +
#                                                          Atr_atr +
#                                                          Mfi +
#                                                          Rsi +
#                                                          Atr_trueLow +
#                                                          Atr_tr +
#                                                          Close_price_5day_lag +
#                                                          Atr_trueHigh,
#                                        data=training_data,
#                                        mtry=m_try,
#                                        importance=TRUE)
#
#           possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
#                                                         uuid,stock_name,
#                                                         model_name,model_desc,
#                                                         model_type,model_comparison_summary_df,
#                                                         validation_data),
#                                    error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
#           add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
#         }
#         generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        #########################################################################
        #########################################################################
        #######             Random Forest Model - Optimisation
        ######              mtry approx equal to SQRT(p)
        #########################################################################
        #########################################################################
        n_trees_list = c(500,1000,2000,3000,4000, 5000)

        for (n_trees in n_trees_list){
          model_name = "Random Forest (mtry = SQRT(p))"
          model_desc = paste("factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | ntrees = ", n_trees, paste="")
          model_type = "OPTIMISATION"
          uuid = UUIDgenerate()
          m_try=3

          #Get the Training and Validation data for the given time window
          training_range = time_window_df[number_sliding_windows,"training_start_index"]:time_window_df[number_sliding_windows,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[number_sliding_windows,"validation_start_index"]:time_window_df[number_sliding_windows,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag + 
                                                          Volume + 
                                                          Close_price_2day_lag + 
                                                          Atr_atr + 
                                                          Mfi + 
                                                          Rsi + 
                                                          Atr_trueLow + 
                                                          Atr_tr +
                                                          Close_price_5day_lag +
                                                          Atr_trueHigh,
                                       data=training_data,
                                       ntree=n_trees,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)

        }

        #########################################################################
        #########################################################################
        #######             Random Forest Model - Testing
        ######              mtry approx equal to SQRT(p)
        #########################################################################
        #########################################################################
        n_trees = 1000
        model_name = "Random Forest (mtry = SQRT(p))"
        model_desc = paste("factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | ntrees = ", n_trees, paste="")
        model_type = "TEST"
        uuid = UUIDgenerate()
        m_try=3

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
          training_data = final_df[training_range,]
          test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
          test_data = final_df[test_range,]

          bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag + 
                                                          Volume + 
                                                          Close_price_2day_lag + 
                                                          Atr_atr + 
                                                          Mfi + 
                                                          Rsi + 
                                                          Atr_trueLow + 
                                                          Atr_tr +
                                                          Close_price_5day_lag +
                                                          Atr_trueHigh,
                                       data=training_data,
                                       ntree=n_trees,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        test_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))
        
        
        #########################################################################
        #########################################################################
        #######             Random Forest Model
        ######              mtry approx equal to p/2
        #########################################################################
        #########################################################################
        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=5

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr +
                                                           Close_price_5day_lag +
                                                           Atr_trueHigh,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=4

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr +
                                                           Close_price_5day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=4

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow +
                                                           Atr_tr,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=3

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi +
                                                           Atr_trueLow,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=3

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi +
                                                           Rsi,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=2

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr +
                                                           Mfi,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=2

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]


          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag +
                                                           Atr_atr,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=1

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume +
                                                           Close_price_2day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)


          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=1

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag +
                                                           Volume,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)


          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()
        m_try=1

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~  Close_price_1day_lag,
                                       data=training_data,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


#         model_name = "Random Forest (mtry = p_div_2)"
# model_desc = "factor(Direction) ~  Close_price_1day_lag^3 + Volume^2 + Close_price_1day_lag + Volume + (Atr_atr * Mfi) + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
#         model_type = "TRAIN"
#         uuid = UUIDgenerate()
#         m_try = 6
#
#         for (tw_index in time_window_seq){
#           #Get the Training and Validation data for the given time window
#           training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
#           training_data = final_df[training_range,]
#           validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
#           validation_data = final_df[validation_range,]
#
#           bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag^3 +
#                                                          Volume^2 +
#                                                          Close_price_1day_lag +
#                                                          Volume, (Atr_atr * Mfi) +
#                                                          Atr_atr +
#                                                          Mfi +
#                                                          Rsi +
#                                                          Atr_trueLow +
#                                                          Atr_tr +
#                                                          Close_price_5day_lag +
#                                                          Atr_trueHigh,
#                                        data=training_data,
#                                        mtry=m_try,
#                                        importance=TRUE)
#
#           possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
#                                                         uuid,stock_name,
#                                                         model_name,model_desc,
#                                                         model_type,model_comparison_summary_df,
#                                                         validation_data),
#                                    error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
#           add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
#         }
#         generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        #########################################################################
        #########################################################################
        #######             Random Forest Model - Optimisation
        ######              mtry approx equal to p_div_2
        #########################################################################
        #########################################################################
        n_trees_list = c(500,1000,2000,3000,4000, 5000)

        for (n_trees in n_trees_list){
          model_name = "Random Forest (mtry = p_div_2)"
          model_desc = paste("factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | ntrees = ", n_trees, paste="")
          model_type = "OPTIMISATION"
          uuid = UUIDgenerate()
          m_try=4

          #Get the Training and Validation data for the given time window
          training_range = time_window_df[number_sliding_windows,"training_start_index"]:time_window_df[number_sliding_windows,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[number_sliding_windows,"validation_start_index"]:time_window_df[number_sliding_windows,"validation_end_index"]
          validation_data = final_df[validation_range,]

          bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag + 
                                                          Volume + 
                                                          Close_price_2day_lag + 
                                                          Atr_atr + 
                                                          Mfi + 
                                                          Rsi + 
                                                          Atr_trueLow + 
                                                          Atr_tr + 
                                                          Close_price_5day_lag + 
                                                          Atr_trueHigh,
                                       data=training_data,
                                       ntree=n_trees,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)

        }
        
        #########################################################################
        #########################################################################
        #######             Random Forest Model  - Testing
        ######              mtry approx equal to p/2
        #########################################################################
        #########################################################################
        n_trees = 4000
        model_name = "Random Forest (mtry = p_div_2)"
        model_desc = paste("factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | ntrees = ", n_trees, paste="")
        model_type = "TEST"
        uuid = UUIDgenerate()
        m_try=4

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
          training_data = final_df[training_range,]
          test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
          test_data = final_df[test_range,]

          bagging_fit = randomForest( factor(Direction) ~ Close_price_1day_lag + 
                                                          Volume + 
                                                          Close_price_2day_lag + 
                                                          Atr_atr + 
                                                          Mfi + 
                                                          Rsi + 
                                                          Atr_trueLow + 
                                                          Atr_tr + 
                                                          Close_price_5day_lag + 
                                                          Atr_trueHigh,
                                       data=training_data,
                                       ntree=n_trees,
                                       mtry=m_try,
                                       importance=TRUE)

          possibleError = tryCatch( run_rdmForest_model(  bagging_fit,n_trees,
                                                        uuid,stock_name,
                                                        model_name,model_desc,
                                                        model_type,model_comparison_summary_df,
                                                        test_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))


        #########################################################################
        #########################################################################
        #######   Support Vector Machine (SVM) - Model Training
        #########################################################################
        #########################################################################
        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag +
                                              Atr_atr +
                                              Mfi +
                                              Rsi +
                                              Atr_trueLow +
                                              Atr_tr +
                                              Close_price_5day_lag +
                                              Atr_trueHigh,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr Close_price_5day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag +
                                              Atr_atr +
                                              Mfi +
                                              Rsi +
                                              Atr_trueLow +
                                              Atr_tr +
                                              Close_price_5day_lag,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag +
                                              Atr_atr +
                                              Mfi +
                                              Rsi +
                                              Atr_trueLow +
                                              Atr_tr,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag +
                                              Atr_atr +
                                              Mfi +
                                              Rsi +
                                              Atr_trueLow,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction)  ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag +
                                              Atr_atr +
                                              Mfi +
                                              Rsi,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction)  ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag +
                                              Atr_atr +
                                              Mfi,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag +
                                              Atr_atr,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag + Volume"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                              Volume,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        model_name = "Support Vector Machine (SVM)"
        model_desc = "factor(Direction) ~ Close_price_1day_lag"
        model_type = "TRAIN"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
          training_data = final_df[training_range,]
          validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
          validation_data = final_df[validation_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        # model_name = "Support Vector Machine (SVM)"
        # model_desc = "factor(Direction) ~  Close_price_1day_lag^3 + Volume^2 + Close_price_1day_lag + Volume + (Atr_atr * Mfi) + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh"
        # model_type = "TRAIN"
        # uuid = UUIDgenerate()
        #
        # for (tw_index in time_window_seq){
        #   #Get the Training and Validation data for the given time window
        #   training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"training_end_index"]
        #   training_data = final_df[training_range,]
        #   validation_range = time_window_df[tw_index,"validation_start_index"]:time_window_df[tw_index,"validation_end_index"]
        #   validation_data = final_df[validation_range,]
        #
        #   svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag^3 +
        #                                       Volume^2 +
        #                                       Close_price_1day_lag +
        #                                       Volume, (Atr_atr * Mfi) +
        #                                       Atr_atr +
        #                                       Mfi +
        #                                       Rsi +
        #                                       Atr_trueLow +
        #                                       Atr_tr +
        #                                       Close_price_5day_lag +
        #                                       Atr_trueHigh,
        #                             probability = TRUE, #indicates the model should allow for probability predictions
        #                             data=training_data)
        #
        #   possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
        #                            error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
        #   add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        # }
        # generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)


        #########################################################################
        #########################################################################
        #######   Support Vector Machine (SVM) - Model Optimisation  (cost/gamma and kernel)
        #########################################################################
        #########################################################################

        #The model above model will be run each cost in the below cost list:
        cost_list = c(0.001 , 0.01 , 0.1, 1 ,100 )
        gamma_list = c(0.01,0.03,0.05,0.5,1,100)
        kernel_list = c("linear", "radial", "sigmoid", "polynomial")

        for (the_kernel in kernel_list){
          for (the_cost in cost_list){
            for (the_gamma in gamma_list){
              model_name = "Support Vector Machine (SVM)"
              model_desc = paste( "factor(Direction) ~ Close_price_1day_lag + Volume + Atr_tr + Close_price_2day_lag + Rsi + Mfi + Close_price_5day_lag + Atr_trueHigh + Atr_trueLow | kernel = ", toString(the_kernel), " | cost = ", toString(the_cost),"| gamma = ", toString(the_gamma), sep="")
              model_type = "OPTIMISATION"
              uuid = UUIDgenerate()

              #The optimisation is performed on the last sliding window
              training_range = time_window_df[number_sliding_windows,"training_start_index"]:time_window_df[number_sliding_windows,"training_end_index"]
              training_data = final_df[training_range,]
              validation_range = time_window_df[number_sliding_windows,"validation_start_index"]:time_window_df[number_sliding_windows,"validation_end_index"]
              validation_data = final_df[validation_range,]

              svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                                  Volume +
                                                  Atr_tr +
                                                  Close_price_2day_lag +
                                                  Rsi +
                                                  Mfi +
                                                  Close_price_5day_lag +
                                                  Atr_trueHigh +
                                                  Atr_trueLow,
                                                  kernel = the_kernel,
                                                  cost = the_cost,
                                                  gamma = the_gamma,
                                        probability = TRUE, #indicates the model should allow for probability predictions
                                        data=training_data)

              possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,validation_data),
                                       error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
              add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
            }
          }
        }

        #########################################################################
        #########################################################################
        #######   Support Vector Machine (SVM) - Model Testing
        #########################################################################
        #########################################################################
        the_kernel = "linear"
        the_cost = 1
        the_gamma = 0.01
        model_name = "Support Vector Machine (SVM)"
        model_desc = paste( "factor(Direction) ~ Close_price_1day_lag + Volume + Close_price_2day_lag + Atr_atr + Mfi + Rsi + Atr_trueLow + Atr_tr + Close_price_5day_lag + Atr_trueHigh | kernel = ", toString(the_kernel), " | cost = ", toString(the_cost),"| gamma = ", toString(the_gamma), sep="")
        model_type = "TEST"
        uuid = UUIDgenerate()

        for (tw_index in time_window_seq){
          #Get the Training and Validation data for the given time window
          training_range = time_window_df[tw_index,"training_start_index"]:time_window_df[tw_index,"validation_end_index"]
          training_data = final_df[training_range,]
          test_range = time_window_df[tw_index,"test_start_index"]:time_window_df[tw_index,"test_end_index"]
          test_data = final_df[test_range,]

          svm_fit =  svm (factor(Direction) ~ Close_price_1day_lag +
                                              Volume +
                                              Close_price_2day_lag +
                                              Atr_atr +
                                              Mfi +
                                              Rsi +
                                              Atr_trueLow +
                                              Atr_tr +
                                              Close_price_5day_lag +
                                                Atr_trueHigh,
                                              kernel = the_kernel,
                                              cost = the_cost,
                                              gamma = the_gamma,
                            probability = TRUE, #indicates the model should allow for probability predictions
                            data=training_data)

          possibleError = tryCatch( run_svm_model(svm_fit,uuid,stock_name,model_name,model_desc,model_type,model_comparison_summary_df,test_data),
                                   error = function(e) print(paste("MODEL ERROR: ", e, sep="")))
          add_failed_model(model_comparison_summary_df,uuid, stock_name, model_name,model_desc,model_type, possibleError)
        }
        generate_avg_model(model_comparison_summary_df,uuid, time_window_seq,model_type)

        cat ("\n")
        cat (paste ("Save Comparison Summary: ", model_name, " \n", sep=""))
        selected_model_df = model_comparison_summary_df[model_comparison_summary_df$model_name == model_name, ]
        print(selected_model_df)
        save_to_csv(selected_model_df, out_dir,paste("Model_Results_", model_name, ".csv", sep=""))
      }
  }
}

#cat ("\n")
#cat ("Save the Model Comparison Summary:\n")
#print(model_comparison_summary_df)
#save_to_csv(model_comparison_summary_df, out_dir,"model_training.csv" )
```        

```{r set}
```
